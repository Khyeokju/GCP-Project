<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드</title>
    <style>
        /* 기본 스타일 설정 */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
    
        body {
            display: flex;
            flex-direction: row;
        }
    
        .container {
            position: relative;
            width: 100%;
            height: 100%;
        }
    
        /* 데스크탑 모드 스타일 */
        .webcam-container {
            width: 70%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            position: relative;
        }
    
        .webcam {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
    
        .webcam img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
    
        .menu-container {
            width: 30%;
            height: 100%;
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
    
        .menu-header {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px;
            background-color: #f0f8ff;
            border: 4px solid #007bff;
            border-radius: 10px;
            padding: 10px 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background-image: linear-gradient(to right, #007bff, #e6f0ff);
        }
    
        .app-title {
            font-size: 80px;
            font-weight: bold;
            color: #f0f8ff;
            text-align: center;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
    
        /* Menu Content */
        .menu-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-top: 20px;
        }
         /* Menu Content Links */
         .menu-content a {
            display: block;
            color: #ffffff;
            background-color: rgb(14, 11, 192);
            padding: 15px 20px;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            width: 100%;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 18px;
            font-weight: 600;
            transition: background-color 0.3s, box-shadow 0.3s, transform 0.3s;
            position: relative;
            overflow: hidden;
        }
    
        .menu-content a:hover {
            background-color: rgb(14, 12, 142);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
    
        .menu-content a:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #00d084;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-in-out;
        }
    
        .menu-content a:hover:before {
            transform: scaleX(1);
            transform-origin: bottom left;
        }
    
        .notification-card {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 400px;
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    display: none;
    text-align: center;
    z-index: 1000;
    max-height: 80vh;
    overflow-y: auto;
    transition: width 0.3s, max-height 0.3s;
}

.notification-card img {
    width: 100%; /* 알림창의 너비에 맞게 이미지 크기 조정 */
    height: auto; /* 이미지의 비율을 유지하며 높이를 자동으로 조정 */
    border-radius: 5px; /* 모서리에 약간의 둥근 효과를 추가 */
    margin-top: 10px; /* 이미지와 텍스트 사이에 여백 추가 */
}

.notification-card .button-container {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px; /* 버튼과 이미지 사이의 간격 */
}
    
        .notification-card a {
            flex: 1;
            padding: 5px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            color: white;
            background-color: #007bff;
            text-decoration: none;
            text-align: center;
            box-sizing: border-box;
            cursor: pointer;
        }
    
        .notification-card a.cancel {
            background-color: #dc3545;
        }
    
        .notification-card a:hover {
            opacity: 0.8;
        }
    
        .toggle-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            z-index: 1001;
        }
    
        .menu-toggle-button {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            z-index: 1001;
        }
    
        .menu-toggle {
            display: none; /* 기본적으로 숨김 */
            position: absolute;
            top: 50px;
            right: 50px;
            background-color: #f0f8ff;
            border: 1px solid #007bff;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }
    
        .menu-toggle a {
            display: block;
            color: #000;
            background-color: transparent;
            padding: 10px;
            text-align: left;
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 5px;
            box-sizing: border-box;
            font-size: 16px;
            transition: background-color 0.3s;
        }
    
        .menu-toggle a:hover {
            background-color: #e6f0ff;
        }
    
        .logout-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: #dc3545;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
    
        .logout-button:hover {
            background-color: #c82333;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
    
        .status-container {
            position: absolute;
            top: 10px; /* 카메라 상단에서의 거리 */
            left: 10px; /* 카메라 왼쪽에서의 거리 */
            width: auto; /* 너비를 자동으로 설정 */
            max-width: 200px; /* 최대 너비 설정 */
            background: rgba(0, 0, 0, 0.5); /* 투명한 배경색 */
            border: 1px solid #007bff;
            border-radius: 10px;
            padding: 4px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); /* 그림자 효과 */
            color: #fff;
            font-size: 14px; /* 폰트 크기 조정 */
            text-align: left; /* 텍스트 왼쪽 정렬 */
            line-height: 1.5;
            z-index: 1002; /* 상태창이 다른 요소 위에 오도록 */
            display: block; /* 상태창 항상 보이도록 설정 */
        }
    
        /* 상태창이 "Fall Down"일 때 텍스트 색상 변경 */
        .status-text.fall-down {
            color: #ff0000; /* 빨간색 텍스트 */
        }
    
        /* 헬멧이 "No Helmet"일 때 텍스트 색상 변경 */
        .status-text.no-helmet {
            color: #ffa500; /* 주황색 텍스트 */
        }
    
        /* 모바일 화면 대응 */
        @media (max-width: 1024px) {
    body {
        flex-direction: column;
    }

    .webcam-container {
        width: 100%;
        height: 100vh; /* 전체 뷰포트 높이로 설정 */
    }

    .menu-container {
        display: none; /* 작은 화면에서는 메뉴바를 숨김 */
    }

    .menu-toggle-button {
        display: block; /* 작은 화면에서는 토글 버튼을 보이도록 설정 */
        top: 10px;
        right: 10px; /* 위치 조정 가능 */
    }

    .menu-toggle {
        display: block; /* 모바일 화면에서 메뉴 토글 버튼 표시 */
    }

    .webcam-container {
        width: 100%;
        height: 100vh; /* 웹캠 컨테이너가 전체 높이를 차지하도록 설정 */
    }

    .webcam {
        width: 100%;
        height: 100vh; /* 웹캠이 전체 높이를 차지하도록 설정 */
    }

    .notification-card {
        bottom: 10px;
        left: 10px;
        width: calc(100% - 20px);
        padding: 10px;
    }
    

    .notification-card p {
        font-size: 14px;
    }

    .notification-card a {
        padding: 8px 10px;
        font-size: 12px;
    }

    .status-container {
        top: 10px;
        left: 10px;
        max-width: 150px;
        font-size: 12px;
    }
}

/* 더 작은 화면을 위한 추가 조정 */
@media (max-width: 576px) {
    .menu-content a {
        padding: 8px;
        font-size: 12px;
        margin-bottom: 8px;
    }

    .status-container {
        top: 5px;
        left: 5px;
        max-width: 120px;
        font-size: 10px;
        padding: 5px;
    }
}
    </style>
</head>
<body>
    <div class="webcam-container">
        <div class="webcam">
            <img id="webcamImage" src="{{ url_for('views.video_feed') }}" alt="CCTV 화면" />
        </div>
        <button class="menu-toggle-button" onclick="toggleMenu()">☰</button>
        <div class="menu-toggle" id="menuToggle">
            <a href="{{ url_for('views.employ_list') }}">현장관리자 & 현장근무자 등록</a>
            <a href="{{ url_for('views.image_list') }}">위험 감지 스냅샷 리스트</a>
            <a href="{{ url_for('views.safe') }}">안전 자가 진단</a>
            <a href="{{ url_for('views.menual') }}">관련 법률 안내</a>
        </div>
        <div class="status-container" id="statusContainer">
            <p class="status-text" id="currentStatus">현재 상태: 로딩 중...</p>
            <p class="status-text" id="helmetStatus">헬멧 착용 여부: 확인 중...</p>
        </div>  
    </div>
    <div class="menu-container">
        <div class="menu-header">
            <h1 class="app-title">Safepro+</h1>
        </div>
        <div class="menu-content">
            <a href="{{ url_for('views.employ_list') }}">현장관리자 & 현장근무자 등록</a>
            <a href="{{ url_for('views.image_list') }}">위험 감지 스냅샷 리스트</a>
            <a href="{{ url_for('views.safe') }}">안전 자가 진단</a>
            <a href="{{ url_for('views.menual') }}">관련 법률 안내</a>
        </div>
        
        
        <a href="{{ url_for('auth.logout') }}" class="logout-button">로그아웃</a>
        
        <div id="notificationCard" class="notification-card">
            <button class="toggle-button" onclick="toggleNotificationCard()">-</button>
            <p id="notificationText">추락이 감지되었습니다!</p>
            <img id="notificationImage" src="" alt="캡처된 이미지" style="display: none;" />
            <div class="button-container">
                <a href="tel:112">112 긴급 연락</a>
                <a href="tel:119">119 긴급 연락</a>
                <a href="{{ url_for('views.employ_list') }}">직원 리스트</a>
                <a href="#" class="cancel" onclick="hideNotification()">취소</a>
            </div>
        </div>
    </div>

    <script>
        let fallTimer = null;
        let isMinimized = false;
        let menuOpen = false;

        function startFallTimer() {
            if (fallTimer) return; // 타이머가 이미 설정되어 있으면 새로운 타이머 설정을 막음

            fallTimer = setTimeout(() => {
                fetch('/status')
                    .then(response => response.json())
                    .then(data => { 
                        const imageUrl = data.image_url;
                        const alertTime = new Date();
                        const formattedTime = alertTime.toLocaleString();

                        showNotification(`${formattedTime} - 비정상 행동 감지`, imageUrl);

                        // 카카오톡 알림 보내기
                        fetch('/send_kakao_alert', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ image_url: imageUrl })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Kakao alert sent:', data);
                        })
                        .catch(err => console.error('Error sending Kakao alert', err));
                    })
                    .catch(err => console.error('Error Fetch Image', err));

                fallTimer = null; // 타이머가 종료되었음을 표시
            }, 20000); // 타이머를 20초로 설정
        }

        function clearFallTimer() {
            if (fallTimer) {
                clearTimeout(fallTimer); // 타이머를 초기화
                fallTimer = null; // 타이머 변수를 초기화하여 새로운 타이머 설정이 가능하도록 함
            }
        }

        function fetchStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const status = data.status || '상태를 확인할 수 없습니다.';
                    const hasHelmet = data.has_helmet || '확인할 수 없음';

                    const currentStatusElement = document.getElementById('currentStatus');
                    const helmetStatusElement = document.getElementById('helmetStatus');

                    currentStatusElement.textContent = `현재 상태: ${status}`;
                    helmetStatusElement.textContent = `헬멧 착용 여부: ${hasHelmet}`;

                    // 상태가 "Fall Down"일 때 알림 시작
                    if (status === 'Fall Down' && !fallTimer) {
                        startFallTimer();
                    } else if (status !== 'Fall Down') {
                        clearFallTimer(); // 상태가 "Fall Down"이 아닐 경우 타이머 초기화
                    }

                    // 상태에 따라 텍스트 색상 변경
                    if (status === 'Fall Down') {
                        currentStatusElement.classList.add('fall-down');
                    } else {
                        currentStatusElement.classList.remove('fall-down');
                    }

                    if (hasHelmet === 'no-helmet') {
                        helmetStatusElement.classList.add('no-helmet');
                    } else {
                        helmetStatusElement.classList.remove('no-helmet');
                    }
                })
                .catch(err => console.error('Error Fetch Status', err));
        }

        function showNotification(message, imageUrl) {
            const notificationCard = document.getElementById('notificationCard');
            const notificationText = document.getElementById('notificationText');
            const notificationImage = document.getElementById('notificationImage');

            notificationText.innerText = message;

            if (imageUrl) {
                notificationImage.src = imageUrl;
                notificationImage.style.display = 'block';
            } else {
                notificationImage.style.display = 'none';
            }

            notificationCard.style.display = 'block';
            isMinimized = false;
        }

        function hideNotification() {
            const notificationCard = document.getElementById('notificationCard');
            notificationCard.style.display = 'none';
            isMinimized = false;
        }

        function toggleNotificationCard() {
            const notificationCard = document.getElementById('notificationCard');
            const toggleButton = document.querySelector('.toggle-button');

            if (isMinimized) {
                notificationCard.style.width = '90%';
                notificationCard.style.maxHeight = '80vh';
                toggleButton.innerText = '-';
            } else {
                notificationCard.style.width = '150px';
                notificationCard.style.maxHeight = '50px';
                toggleButton.innerText = '+';
            }

            isMinimized = !isMinimized;
        }

        function toggleMenu() {
            const menuToggle = document.getElementById('menuToggle');

            if (menuOpen) {
                menuToggle.style.display = 'none';
            } else {
                menuToggle.style.display = 'block';
            }

            menuOpen = !menuOpen;
        }

        const notificationCard = document.getElementById('notificationCard');
        let isDragging = false;
        let offsetX = 0;
        let offsetY = 0;

        notificationCard.addEventListener('mousedown', (e) => {
            isDragging = true;
            offsetX = e.clientX - notificationCard.getBoundingClientRect().left;
            offsetY = e.clientY - notificationCard.getBoundingClientRect().top;
            notificationCard.style.cursor = 'move';
        });

        window.addEventListener('mousemove', (e) => {
            if (isDragging) {
                notificationCard.style.left = `${e.clientX - offsetX}px`;
                notificationCard.style.top = `${e.clientY - offsetY}px`;
            }
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            notificationCard.style.cursor = 'auto';
        });

        setInterval(fetchStatus, 1000);
    </script>
</body>
</html>
